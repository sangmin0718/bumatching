<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>짝자 라이브 매칭 (단일파일)</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial; margin: 24px; background:#fafafa; }
    h1 { margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
    label { display:block; margin:6px 0 2px; font-weight: 600; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%; border:1px solid #d1d5db; border-radius: 8px; padding: 8px;
    }
    button { padding: 10px 14px; border:1px solid #111827; background:#111827; color:#fff; border-radius: 8px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 10px; font-size: 14px; }
    th { text-align: left; background: #f3f4f6; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <h1>짝자 라이브 매칭 데모</h1>

  <div class="grid">
    <div class="card">
      <h3>참가자 등록</h3>
      <form id="formAdd">
        <label>성별</label>
        <select name="gender" required>
          <option value="여">여</option>
          <option value="남">남</option>
        </select>

        <label>이름</label>
        <input type="text" name="name" required />

        <label>닉네임</label>
        <input type="text" name="nickName" required />

        <label>자기소개 (bio)</label>
        <input type="text" name="bio" placeholder="예: 천안 사는 박보검입니다." required />

        <label>이상형 코멘트</label>
        <input type="text" name="myComment" placeholder="예: 여행 좋아하는 분이면 좋겠어요" />

        <label>나이</label>
        <input type="number" name="age" min="20" max="29" required />

        <label>학부/학과</label>
        <select id="college" name="college" required></select>

        <label>MBTI</label>
        <input type="text" name="mbti" placeholder="ENFP" required />

        <label>취미</label>
        <div id="hobbyChecks"></div>

        <label>지역 (시)</label>
        <select id="region" name="region" required></select>

        <label>전화번호 (선택)</label>
        <input type="text" name="phone" placeholder="010-0000-0000 (없으면 비워두기)" />

        <label>인스타그램 (선택)</label>
        <input type="text" name="ig" placeholder="@handle (없으면 비워두기)" />

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button type="submit">등록 + 즉시 매칭</button>
          <button type="button" id="btnExport" style="background:#2563eb;border-color:#2563eb;">JSON 내보내기</button>
          <button type="button" id="btnClear" style="background:#991b1b;border-color:#991b1b;">전체 삭제</button>
        </div>
      </form>
      <p class="muted" style="margin-top:8px;">마지막 등록: <span id="lastAdded">-</span></p>
      <p class="muted">전체: <span id="countAll">0</span>명 · 남: <span id="countMen">0</span>명 · 여: <span id="countWomen">0</span>명</p>
    </div>

    <div class="card">
      <h3>방금 등록한 사람 기준 상위 3 추천</h3>
      <table>
        <thead><tr><th>닉네임</th><th>소개</th><th>이상형 코멘트</th><th>점수</th></tr></thead>
        <tbody id="tbodyResults"></tbody>
      </table>
      <p class="muted">등록 후 자동으로 반대 성별 풀에서 상위 3명을 보여줍니다.</p>
    </div>
  </div>

  <script>
    /* ===================== 상수/옵션 ===================== */
    const LS_KEY = 'jjagja_participants_live_v1';
    const COLLEGES = [
      "기독교학부","어문학부","사회복지학부","경찰학부","경상학부","관광학부",
      "컴퓨터공학부","보건학부","간호학과","사범학부","문화예술학부","첨단IT공학부",
      "디자인영상학부","스포츠과학부","외식산업학부"];

    const CITIES = [
      "서울특별시", "인천광역시", "대구광역시", "대전광역시", "광주광역시", "울산광역시", "세종특별자치시", "충청북도",
      "충청남도", "전라남도", "경상북도", "경상남도", "강원특별자치도", "전북특별자치도", "제주특별자치도"];
  
    const HOBBIES = ["운동", "영화", "음악", "여행", "독서", "게임", "요리", "사진", "카페", "등산", "야구", "드라마", "애니", "드라이브", "전시회", "베이킹", "산책"];

    /* ===================== MBTI 점수표 ===================== */
    const MBTI_SCORES = {
      INFP: {
        INFP: 30, ENFP: 30, INFJ: 30, ENFJ: 40,
        INTJ: 30, ENTJ: 40, INTP: 30, ENTP: 30,
        ISFP:  5, ESFP:  5, ISTP:  5, ESTP:  5,
        ISFJ: 10, ESFJ: 5, ISTJ: 5, ESTJ: 5
      },
      ENFP: {
        INFP: 30, ENFP: 30, INFJ: 40, ENFJ: 30,
        INTJ: 40, ENTJ: 30, INTP: 30, ENTP: 30,
        ISFP:  5, ESFP:  5, ISTP:  5, ESTP:  5,
        ISFJ: 5, ESFJ: 5, ISTJ: 5, ESTJ: 5
      },
      INFJ: {
        INFP: 30, ENFP: 40, INFJ: 30, ENFJ: 30,
        INTJ: 30, ENTJ: 30, INTP: 30, ENTP: 40,
        ISFP: 5, ESFP: 5, ISTP: 5, ESTP: 5,
        ISFJ: 5, ESFJ: 5, ISTJ: 5, ESTJ: 5
      },
      ENFJ: {
        INFP: 40, ENFP: 30, INFJ: 30, ENFJ: 30,
        INTJ: 30, ENTJ: 30, INTP: 30, ENTP: 30,
        ISFP: 40, ESFP: 5, ISTP: 5, ESTP: 5,
        ISFJ: 5, ESFJ: 5, ISTJ: 5, ESTJ: 5
      },
      INTJ: {
        INFP: 30, ENFP: 40, INFJ: 30, ENFJ: 30,
        INTJ: 30, ENTJ: 30, INTP: 30, ENTP: 40,
        ISFP: 20, ESFP: 20, ISTP: 20, ESTP: 20,
        ISFJ: 15, ESFJ: 15, ISTJ: 15, ESTJ: 15
      },
      ENTJ: {
        INFP: 40, ENFP: 30, INFJ: 30, ENFJ: 30,
        INTJ: 30, ENTJ: 30, INTP: 40, ENTP: 30,
        ISFP: 20, ESFP: 20, ISTP: 20, ESTP: 20,
        ISFJ: 20, ESFJ: 20, ISTJ: 20, ESTJ: 20
      },
      INTP: {
        INFP: 30, ENFP: 30, INFJ: 30, ENFJ: 30,
        INTJ: 30, ENTJ: 40, INTP: 30, ENTP: 30,
        ISFP: 20, ESFP: 20, ISTP: 20, ESTP: 20,
        ISFJ: 15, ESFJ: 15, ISTJ: 15, ESTJ: 40
      },
      ENTP: {
        INFP: 30, ENFP: 30, INFJ: 40, ENFJ: 30,
        INTJ: 40, ENTJ: 30, INTP: 30, ENTP: 30,
        ISFP: 20, ESFP: 20, ISTP: 20, ESTP: 20,
        ISFJ: 15, ESFJ: 15, ISTJ: 15, ESTJ: 15
      },
      ISFP: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 40,
        INTJ: 20, ENTJ: 20, INTP: 20, ENTP: 20,
        ISFP: 15, ESFP: 15, ISTP: 15, ESTP: 15,
        ISFJ: 20, ESFJ: 40, ISTJ: 20, ESTJ: 40
      },
      ESFP: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 20, ENTJ: 20, INTP: 20, ENTP: 20,
        ISFP: 15, ESFP: 15, ISTP: 15, ESTP: 15,
        ISFJ: 40, ESFJ: 20, ISTJ: 40, ESTJ: 20
      },
      ISTP: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 20, ENTJ: 20, INTP: 20, ENTP: 20,
        ISFP: 15, ESFP: 15, ISTP: 15, ESTP: 15,
        ISFJ: 20, ESFJ: 40, ISTJ: 20, ESTJ: 40
      },
      ESTP: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 20, ENTJ: 20, INTP: 20, ENTP: 20,
        ISFP: 15, ESFP: 15, ISTP: 15, ESTP: 15,
        ISFJ: 40, ESFJ: 20, ISTJ: 40, ESTJ: 20
      },
      ISFJ: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 15, ENTJ: 20, INTP: 15, ENTP: 15,
        ISFP: 20, ESFP: 40, ISTP: 20, ESTP: 40,
        ISFJ: 30, ESFJ: 30, ISTJ: 30, ESTJ: 30
      },
      ESFJ: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 15, ENTJ: 20, INTP: 15, ENTP: 15,
        ISFP: 40, ESFP: 20, ISTP: 40, ESTP: 20,
        ISFJ: 30, ESFJ: 30, ISTJ: 30, ESTJ: 30
      },
      ISTJ: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 15, ENTJ: 20, INTP: 15, ENTP: 15,
        ISFP: 20, ESFP: 40, ISTP: 20, ESTP: 40,
        ISFJ: 30, ESFJ: 30, ISTJ: 30, ESTJ: 30
      },
      ESTJ: {
        INFP:  5, ENFP:  5, INFJ: 5, ENFJ: 5,
        INTJ: 15, ENTJ: 20, INTP: 40, ENTP: 15,
        ISFP: 40, ESFP: 20, ISTP: 40, ESTP: 20,
        ISFJ: 30, ESFJ: 30, ISTJ: 30, ESTJ: 30
      }
    };

    /* ===================== 유틸/스토어 ===================== */
    const $ = (id) => document.getElementById(id);

    function loadAll() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function saveAll(list) {
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }
    function nextId(list) {
      return list.reduce((m, p) => Math.max(m, p.id || 0), 0) + 1;
    }
    function normalize(p) {
      const hobbyMap = { '헬스': '운동' };
      const hobbies = (p.hobbies || []).map(h => hobbyMap[h] || h);
      const mbti = String(p.mbti || '').toUpperCase();

      return {
        id: p.id ?? 0,
        gender: p.gender, // "남"/"여"
        name: (p.name || '').trim(),
        nickName: (p.nickName || '').trim(),
        bio: (p.bio || '').trim(),
        myComment: (p.myComment || '').trim(),
        status: p.status || 'waiting',
        age: Number(p.age),
        college: p.college,
        mbti,
        hobbies,
        region: p.region,
        phone: p.phone ?? '',
        ig: p.ig ?? ''
      };
    }
    function addParticipant(p) {
      const list = loadAll();
      const n = normalize(p);
      n.id = nextId(list);
      list.push(n);
      saveAll(list);
      return n;
    }
    function filterByGender(g) {
      return loadAll().filter(p => p.gender === g);
    }
    function clearAll() {
      localStorage.removeItem(LS_KEY);
    }
    function exportJson() {
      const data = JSON.stringify(loadAll(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'participants_export.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* ===================== 점수 엔진 ===================== */
    function mbtiScore(a, b) {
      a = String(a || '').toUpperCase();
      b = String(b || '').toUpperCase();
      if (MBTI_SCORES[a] && MBTI_SCORES[a][b] !== undefined) return MBTI_SCORES[a][b];
      if (MBTI_SCORES[b] && MBTI_SCORES[b][a] !== undefined) return MBTI_SCORES[b][a];
      return 10; // fallback
    }
    function getHobbiesScore(aHobbies, bHobbies) {
      const setA = new Set(aHobbies || []);
      const common = (bHobbies || []).filter(h => setA.has(h));
      if (common.length >= 2) return 20;
      if (common.length === 1) return 10;
      return 0;
    }
    function getRegionScore(aRegion, bRegion) {
      if (!aRegion || !bRegion) return 5;
      if (aRegion === bRegion) return 20; // 같은 시
      const aTop = aRegion.split(' ')[0], bTop = bRegion.split(' ')[0];
      if (aTop && bTop && aTop === bTop) return 15;
      return 5;
    }
    function getAgeScore(aAge, bAge) {
      const d = Math.abs((aAge ?? 0) - (bAge ?? 0));
      if (d <= 2) return 15;
      if (d <= 3) return 10;
      if (d <= 6) return 5;
      return 0;
    }
    function getCollegeScore(aCollege, bCollege) {
      if (!aCollege || !bCollege) return 0;
      return aCollege === bCollege ? 0 : 5; // 다양성
    }
    function computeTotal(seeker, candidate) {
    const mbtiRaw   = mbtiScore(seeker.mbti, candidate.mbti);   // 0~40
    const hobbyRaw  = getHobbiesScore(seeker.hobbies, candidate.hobbies); // 0/10/20
    const regionRaw = getRegionScore(seeker.region, candidate.region);    // 5/15/20
    const ageRaw    = getAgeScore(seeker.age, candidate.age);             // 0/5/10/15
    const collegeRaw= getCollegeScore(seeker.college, candidate.college); // 0/5

    const total = mbtiRaw + hobbyRaw + regionRaw + ageRaw + collegeRaw;   // 0~100
    return Math.round(total);
  }
    function getTopMatches(seeker, pool, topK = 3) {
      return pool
        .filter(p => p.id !== seeker.id && p.status !== 'matched')
        .map(c => ({
          nickName: c.nickName,
          bio: c.bio,
          myComment: c.myComment,
          total: computeTotal(seeker, c),
          id: c.id
        }))
        .sort((a, b) => b.total - a.total)
        .slice(0, topK);
    }

    /* ===================== UI 바인딩 ===================== */
    function fillSelect(el, arr){
      el.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join('');
    }
    function fillChecks(container, arr){
      container.innerHTML = arr.map(v => `
        <label style="margin-right:10px"><input type="checkbox" name="hobbies" value="${v}"> ${v}</label>
      `).join('');
    }
    function readHobbies(container){
      return [...container.querySelectorAll('input[name="hobbies"]:checked')].map(i => i.value);
    }
    function renderTop3(rows){
      const tbody = $('tbodyResults');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.nickName}</td>
          <td>${r.bio}</td>
          <td>${r.myComment}</td>
          <td style="text-align:right">${r.total}</td>
        </tr>
      `).join('');
    }
    function refreshCounts(){
      const all = loadAll();
      $('countAll').textContent = String(all.length);
      $('countMen').textContent = String(all.filter(p => p.gender === '남').length);
      $('countWomen').textContent = String(all.filter(p => p.gender === '여').length);
    }

    document.addEventListener('DOMContentLoaded', () => {
      fillSelect($('college'), COLLEGES);
      fillSelect($('region'), CITIES);
      fillChecks($('hobbyChecks'), HOBBIES);
      refreshCounts();

      $('formAdd').addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const p = {
          gender: fd.get('gender'),
          name: fd.get('name'),
          nickName: fd.get('nickName'),
          bio: fd.get('bio'),
          myComment: fd.get('myComment'),
          age: Number(fd.get('age')),
          college: fd.get('college'),
          mbti: fd.get('mbti'),
          hobbies: readHobbies($('hobbyChecks')),
          region: fd.get('region'),
          phone: (fd.get('phone') || '').trim(),
          ig: (fd.get('ig') || '').trim()
        };
        const added = addParticipant(p);
        e.currentTarget.reset();
        refreshCounts();

        const targetGender = (added.gender === '남') ? '여' : '남';
        const pool = filterByGender(targetGender);
        const top3 = getTopMatches(added, pool, 3);
        renderTop3(top3);

        $('lastAdded').textContent = `${added.nickName} (#${added.id})`;
      });

      $('btnExport').addEventListener('click', exportJson);
      $('btnClear').addEventListener('click', () => { clearAll(); renderTop3([]); refreshCounts(); $('lastAdded').textContent='-'; });
    });
  </script>
</body>
</html>
